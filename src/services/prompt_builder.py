def get_final_prompt(text, mode, image_url=None):
    """Генерация промпта в зависимости от режима"""
    if image_url:
        if mode == "code":
            return text or "Проанализируй код на этом изображении. Объясни, что он делает, и найди ошибки."
        elif mode == "math":
            return text or "Реши эти задачи подробно с пошаговым объяснением."
        elif mode == "raw":
            return text or "Что на этом изображении?"
    else:
        # Только текст
        if mode == "code":
            return f"""Ты — эксперт по программированию и ассистент по коду. Твой ответ должен содержать только код и краткие объяснения. Не используй LaTeX. Оборачивай блоки кода в ``` (например, ```python ... ```).

Запрос: {text}"""
        elif mode == "math":
            return f"""Ты — ИИ-ассистент, специализирующийся на математике. Решай задачи пошагово. Используй LaTeX для всех формул (например, $\\frac{{a}}{{b}}$ или \\\\\\[ ... \\\\\\]).

Запрос: {text}"""
        elif mode == "raw":
            return text
            
    return text # Fallback